<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MIB Badge Creator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: white;
      overflow-y: auto;
      touch-action: auto;
    }
    .main-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 20px;
      min-height: 100vh;
      overflow-y: auto;
      touch-action: auto;
    }
    .top-buttons {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
      max-width: 772.98px;
    }
    .top-buttons a.button,
    .top-buttons .upload-container {
      width: 376.49px;
      margin: 0;
      touch-action: none;
    }
    .canvas-and-controls {
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      width: 100%;
      justify-content: center;
      gap: 20px;
    }
    #canvas-container {
      width: 387px;
      height: 614px;
      max-width: 100%;
      background-image: url('https://raw.githubusercontent.com/awesem0/MBI/main/image2.png');
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      position: relative;
      flex-shrink: 0;
      margin-left: 0px;
      background-color: white;
      touch-action: manipulation;
      aspect-ratio: 387 / 614;
    }
    .main-container.landscape #canvas-container {
      width: 614px;
      height: 387px;
      max-width: 100%;
      aspect-ratio: 614 / 387;
    }
    canvas {
      width: 100%;
      height: 100%;
      background-color: transparent;
      display: block;
    }
    .controls {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      flex-grow: 1;
      max-width: 370.82px;
      touch-action: auto;
    }
    .main-container:not(.landscape) .controls {
      margin-top: 76px;
    }
    .photo-controls, .glasses-controls {
      display: flex;
      flex-direction: column;
      width: 370.82px;
    }
    .glasses-controls {
      margin-right: 18.9px;
    }
    .download-section {
      width: 100%;
      margin-top: 20px;
    }
    .download-section button {
      width: 100%;
      max-width: 370.82px;
      height: 66px;
      background-color: #000000;
    }
    .download-section button:active {
      background-color: #4D8CFF;
    }
    .slider-container {
      display: flex;
      align-items: center;
      margin: 10px 0;
      width: 370.82px;
    }
    .slider-container label {
      width: 90px;
      text-align: left;
      font-size: 16px;
    }
    .slider-container input[type="range"] {
      flex: 1;
      height: 20px;
      width: 100%;
      touch-action: auto;
    }
    .inactive {
      opacity: 0.5;
      pointer-events: none;
    }
    button, a.button, label.upload-button {
      margin: 0;
      cursor: pointer;
      background-color: #000000;
      color: white;
      border: 3px solid #000000;
      border-radius: 8px;
      height: 66px;
      text-align: center;
      box-sizing: border-box;
      display: flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      font-size: 16px;
      font-weight: bold;
    }
    button:hover, a.button:hover, label.upload-button:hover {
      background-color: #333333;
    }
    .hidden {
      display: none;
    }
    .glasses-selection {
      display: flex;
      flex-direction: column;
      margin: 10px 0;
    }
    .glasses-row {
      display: flex;
      gap: 10px;
    }
    .glasses-button {
      width: 73.78px;
      height: 50px;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      background-color: transparent;
      border: 2px solid #000000;
      border-radius: 5px;
      cursor: pointer;
    }
    .glasses-button:hover {
      background-color: #f0f0f0;
    }
    .glasses-button.selected {
      border-color: #ff0000;
    }
    .layer-buttons {
      display: flex;
      gap: 5px;
      margin: 10px 0;
      width: 370.82px;
    }
    .layer-buttons button {
      width: 182.91px;
      padding: 0;
      margin: 0;
      height: 66px;
    }
    .download-container {
      margin: 10px 0;
      width: 100%;
    }
    .upload-container {
      position: relative;
    }
    .upload-container input[type="file"] {
      display: none;
    }
    #loading-message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 20px;
      background: rgba(0, 0, 0, 0.7);
      padding: 10px;
      border-radius: 5px;
      display: none;
    }
    .disclaimer {
      text-align: center;
      font-size: 14px;
      margin-bottom: 10px;
      max-width: 772.98px;
    }
    .video-tutorial {
      margin: 20px 0;
      text-align: center;
      max-width: 902.9px;
      width: 100%;
      position: relative;
    }
    .video-tutorial iframe {
      max-width: 100%;
      width: 100%;
      height: auto;
      aspect-ratio: 16 / 9;
    }
    @media (max-width: 740px) {
      .main-container {
        align-items: center;
        min-height: auto;
        margin: 10px;
      }
      .top-buttons {
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
        width: 100%;
        max-width: 100%;
      }
      .top-buttons a.button,
      .top-buttons .upload-container {
        width: calc(45% + 3.78px);
        box-sizing: border-box;
        height: 35px;
      }
      a.button, label.upload-button {
        height: 35px;
        font-size: 10px;
        padding: 0 8px;
      }
      .canvas-and-controls {
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 2.5px;
      }
      #canvas-container {
        width: 100%;
        max-width: 100%;
        height: auto;
        margin-bottom: 20px;
        margin-left: 0;
      }
      .main-container.landscape #canvas-container {
        width: 100%;
        max-width: 100%;
        height: auto;
        margin-bottom: 0;
      }
      .controls {
        align-items: center;
        max-width: 100%;
        width: 100%;
        margin-top: 0;
      }
      .main-container:not(.landscape) .controls {
        margin-top: 20px;
      }
      .photo-controls, .glasses-controls {
        width: 100%;
        max-width: 100%;
      }
      .glasses-controls {
        margin-right: 0;
      }
      .slider-container {
        width: 100%;
      }
      .slider-container input[type="range"] {
        height: 20px;
        width: 100%;
      }
      .glasses-selection {
        width: 100%;
      }
      .glasses-row {
        justify-content: space-between;
        gap: 5px;
      }
      .glasses-button {
        width: 60px;
        height: 40px;
      }
      .layer-buttons {
        width: 100%;
        margin: 3.2px 0;
      }
      .layer-buttons button {
        width: 50%;
        height: 35px;
        font-size: 10px;
      }
      .download-section {
        width: 100%;
        max-width: 100%;
        margin-top: 10px;
        margin-bottom: 20px;
      }
      .download-section button {
        height: 35px;
        font-size: 12px;
        width: 100%;
        max-width: 100%;
      }
      .disclaimer {
        font-size: 12px;
      }
      .video-tutorial iframe {
        width: 100%;
        height: auto;
        max-width: 100%;
        aspect-ratio: 16 / 9;
      }
    }
    @media (max-width: 772.98px) and (min-width: 741px) {
      .top-buttons {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <div class="disclaimer">
      This is a fictional graphic tool for fun only. No data is stored.
    </div>
    <div class="top-buttons">
      <a href="https://www.etsy.com/uk/listing/1816298681/editable-mib-agent-badge-free-edit-tool" target="_blank" class="button" id="buy-template">BUY TEMPLATE</a>
      <a href="https://www.pixelcut.ai/t/background-remover" target="_blank" class="button" id="remove-bg">REMOVE PHOTO BACKGROUND</a>
      <div class="upload-container">
        <label for="templateUpload" class="upload-button" id="upload-template-label">UPLOAD TEMPLATE</label>
        <input type="file" id="templateUpload" accept="image/*">
      </div>
      <div class="upload-container">
        <label for="photoUpload" class="upload-button" id="upload-photo-label">UPLOAD PHOTO</label>
        <input type="file" id="photoUpload" accept="image/*">
      </div>
    </div>
    <div class="canvas-and-controls">
      <div id="canvas-container">
        <div id="loading-message">Loading...</div>
      </div>
      <div class="controls">
        <div class="photo-controls">
          <div id="photo-sliders" class="hidden">
            <div class="slider-container">
              <label for="scale">Scale: </label>
              <input type="range" id="scale" min="0.1" max="2" step="0.01" value="1.25" />
            </div>
            <div class="slider-container">
              <label for="xPos">Left Right: </label>
              <input type="range" id="xPos" min="-307" max="307" value="56.69" />
            </div>
            <div class="slider-container">
              <label for="yPos">Up Down: </label>
              <input type="range" id="yPos" min="-193.5" max="193.5" value="-18.9" />
            </div>
            <div class="slider-container">
              <label for="rotation">Rotation: </label>
              <input type="range" id="rotation" min="-10" max="10" step="0.1" value="0" />
            </div>
            <div class="layer-buttons">
              <button id="sendBack">SEND TO BACK</button>
              <button id="bringFront">BRING TO FRONT</button>
            </div>
          </div>
        </div>
        <div class="glasses-controls">
          <div id="glasses-sliders" class="hidden">
            <div class="slider-container">
              <label for="glassesScale">Scale: </label>
              <input type="range" id="glassesScale" min="0.1" max="2.5" step="0.01" value="0.50625" />
            </div>
            <div class="slider-container">
              <label for="glassesXPos">Left Right: </label>
              <input type="range" id="glassesXPos" min="-307" max="307" value="57" />
            </div>
            <div class="slider-container">
              <label for="glassesYPos">Up Down: </label>
              <input type="range" id="glassesYPos" min="-193.5" max="193.5" value="-57" />
            </div>
            <div class="slider-container">
              <label for="glassesRotation">Rotation: </label>
              <input type="range" id="glassesRotation" min="-10" max="10" step="0.1" value="0" />
            </div>
            <div class="glasses-selection">
              <div class="glasses-row">
                <button id="glasses1" class="glasses-button selected"></button>
                <button id="glasses2" class="glasses-button"></button>
                <button id="glasses3" class="glasses-button"></button>
                <button id="glasses4" class="glasses-button"></button>
              </div>
            </div>
          </div>
        </div>
        <div class="download-section">
          <div class="download-container">
            <button id="download">DOWNLOAD</button>
          </div>
        </div>
      </div>
    </div>
    <div class="video-tutorial">
      <iframe width="720" height="405" src="https://www.youtube.com/embed/-tZjoTCj4hg?si=ZzJND3zSDC3YG2ZK&vq=hd720" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
    </div>
  </div>
  <script>
    let templateImg, photoImg, glassesImgs = [], currentGlassesImg;
    let xPos = 56.69, yPos = -18.9, scaleVal = 1.25, rotationVal = 0;
    let glassesXPos = 57, glassesYPos = -57, glassesScaleVal = 0.50625, glassesRotationVal = 0;
    let photoInFront = true;
    let templateLoaded = false, photoLoaded = false;
    let glassesSelected = false;
    let photoAspectRatio = 1;
    let canvasWidth = 387, canvasHeight = 614;
    let isLandscape = false;
    let hasDownloaded = false;
    let relativeGlassesX = 0, relativeGlassesY = 0;
    let relativeRotation = 0;
    let relativeScale = 1;
    let activeElement = 'photo';
    let originalTemplateWidth, originalTemplateHeight;
    const glassesUrls = [
      'https://i.imgur.com/dN1UAzY.png',
      'https://i.imgur.com/VmJZVVc.png',
      'https://i.imgur.com/kQaHUfH.png',
      'https://i.imgur.com/oG0sHMC.png'
    ];
    const loadingMessage = document.getElementById('loading-message');
    let canvas;
    let isDraggingPhoto = false;
    let photoDragStartX, photoDragStartY;
    let isPinchingPhoto = false;
    let initialPinchDistancePhoto = 0;
    let initialScalePhoto = 1;
    let isDraggingGlasses = false;
    let glassesDragStartX, glassesDragStartY;
    let isPinchingGlasses = false;
    let initialPinchDistanceGlasses = 0;
    let initialScaleGlasses = 1;
    let lastUploadTrigger = { template: 0, photo: 0 };
    function preload() {
      glassesUrls.forEach((url, index) => {
        loadImage(url,
          (img) => {
            glassesImgs[index] = img;
            document.getElementById(`glasses${index + 1}`).style.backgroundImage = `url('${url}')`;
          },
          (err) => {
            alert(`Failed to load glasses image ${index + 1}. Please try refreshing the page or contact support.`);
          }
        );
      });
    }
    function setup() {
      canvas = createCanvas(canvasWidth, canvasHeight);
      canvas.parent('canvas-container');
      background(0, 0, 0, 0);
      pixelDensity(2);
      document.querySelector('#photo-sliders').classList.add('hidden');
      document.querySelector('#glasses-sliders').classList.add('hidden');
      document.querySelector('.download-section').classList.add('hidden');
      updateCanvasSize();
      updateSliderVisibility();
    }
    function updateCanvasSize() {
      const container = document.getElementById('canvas-container');
      const containerWidth = container.offsetWidth;
      canvasWidth = containerWidth;
      canvasHeight = isLandscape ? containerWidth * (387 / 614) : containerWidth * (614 / 387);
      resizeCanvas(canvasWidth, canvasHeight);
      if (photoLoaded) {
        document.querySelector('#photo-sliders').classList.remove('hidden');
        document.querySelector('#glasses-sliders').classList.remove('hidden');
        document.querySelector('.download-section').classList.remove('hidden');
      } else {
        document.querySelector('#photo-sliders').classList.add('hidden');
        document.querySelector('#glasses-sliders').classList.add('hidden');
        document.querySelector('.download-section').classList.add('hidden');
      }
      updateSliderRanges();
    }
    function updateSliderRanges() {
      const xMax = canvasWidth / 2;
      const yMax = canvasHeight / 2;
      document.getElementById('xPos').setAttribute('min', -xMax);
      document.getElementById('xPos').setAttribute('max', xMax);
      document.getElementById('yPos').setAttribute('min', -yMax);
      document.getElementById('yPos').setAttribute('max', yMax);
      document.getElementById('glassesXPos').setAttribute('min', -xMax);
      document.getElementById('glassesXPos').setAttribute('max', xMax);
      document.getElementById('glassesYPos').setAttribute('min', -yMax);
      document.getElementById('glassesYPos').setAttribute('max', yMax);
    }
    function updateSliderVisibility() {
      const photoSliders = document.querySelector('#photo-sliders');
      const glassesSliders = document.querySelector('#glasses-sliders');
      if (activeElement === 'photo') {
        photoSliders.classList.remove('inactive');
        glassesSliders.classList.add('inactive');
      } else if (activeElement === 'glasses') {
        photoSliders.classList.add('inactive');
        glassesSliders.classList.remove('inactive');
      }
      document.querySelectorAll('.glasses-button').forEach(btn => {
        btn.style.pointerEvents = 'auto';
        btn.style.opacity = '1';
      });
    }
    function isMouseOverPhoto(x, y) {
      if (!photoLoaded || !photoImg) return false;
      let scaledHeight = photoImg.height * scaleVal;
      let scaledWidth = scaledHeight * photoAspectRatio;
      let padding = 1.5;
      let paddedWidth = scaledWidth * padding;
      let paddedHeight = scaledHeight * padding;
      let photoX = xPos + canvasWidth / 2 - paddedWidth / 2;
      let photoY = yPos + canvasHeight / 2 - paddedHeight / 2;
      return x >= photoX && x <= photoX + paddedWidth && y >= photoY && y <= photoY + paddedHeight;
    }
    function isMouseOverGlasses(x, y) {
      if (!glassesSelected || !currentGlassesImg || hasDownloaded) return false;
      let scaledWidth = currentGlassesImg.width * glassesScaleVal;
      let scaledHeight = currentGlassesImg.height * glassesScaleVal;
      let padding = 3.0;
      let paddedWidth = scaledWidth * padding;
      let paddedHeight = scaledHeight * padding;
      let glassesX = glassesXPos + canvasWidth / 2 - paddedWidth / 2;
      let glassesY = glassesYPos + canvasHeight / 2 - paddedHeight / 2;
      return x >= glassesX && x <= glassesX + paddedWidth && y >= glassesY && y <= glassesY + paddedHeight;
    }
    function isTouchOverButton(x, y) {
      const buttons = document.querySelectorAll('button, a.button, label.upload-button');
      for (let btn of buttons) {
        const rect = btn.getBoundingClientRect();
        if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
          return true;
        }
      }
      return false;
    }
    function isTouchOverSlider(x, y) {
      const sliders = document.querySelectorAll('input[type="range"]');
      for (let slider of sliders) {
        const rect = slider.getBoundingClientRect();
        const parent = slider.closest('.photo-controls, .glasses-controls');
        if (parent.classList.contains('inactive')) continue;
        if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
          return true;
        }
      }
      return false;
    }
    function isTouchOverCanvas(x, y) {
      const canvasContainer = document.getElementById('canvas-container');
      const rect = canvasContainer.getBoundingClientRect();
      return x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom;
    }
    function isTouchOverControls(x, y) {
      const controls = document.querySelector('.controls');
      const rect = controls.getBoundingClientRect();
      const overControls = x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom;
      if (overControls) {
        if (isTouchOverButton(x, y) || isTouchOverSlider(x, y)) {
          return true;
        }
      }
      return false;
    }
    function mousePressed() {
      if (activeElement === 'photo' && photoLoaded && isMouseOverPhoto(mouseX, mouseY)) {
        isDraggingPhoto = true;
        photoDragStartX = mouseX - xPos;
        photoDragStartY = mouseY - yPos;
      } else if (activeElement === 'glasses' && glassesSelected && !hasDownloaded && isMouseOverGlasses(mouseX, mouseY)) {
        isDraggingGlasses = true;
        glassesDragStartX = mouseX - glassesXPos;
        glassesDragStartY = mouseY - glassesYPos;
        hasDownloaded = false;
      }
    }
    function mouseReleased() {
      isDraggingPhoto = false;
      isDraggingGlasses = false;
    }
    function mouseDragged() {
      if (isDraggingPhoto && activeElement === 'photo') {
        xPos = mouseX - photoDragStartX;
        yPos = mouseY - photoDragStartY;
        document.getElementById('xPos').value = xPos;
        document.getElementById('yPos').value = yPos;
        hasDownloaded = false;
      } else if (isDraggingGlasses && activeElement === 'glasses' && !hasDownloaded) {
        glassesXPos = mouseX - glassesDragStartX;
        glassesYPos = mouseY - glassesDragStartY;
        document.getElementById('glassesXPos').value = glassesXPos;
        document.getElementById('glassesYPos').value = glassesYPos;
        hasDownloaded = false;
      }
    }
    function touchStarted(event) {
      if (touches.length === 1) {
        let touchX = touches[0].x;
        let touchY = touches[0].y;
        if (isTouchOverButton(touchX, touchY)) {
          return true;
        }
        if (isTouchOverSlider(touchX, touchY)) {
          return true;
        }
        if (isTouchOverCanvas(touchX, touchY)) {
          if (activeElement === 'photo' && photoLoaded && isMouseOverPhoto(touchX, touchY)) {
            isDraggingPhoto = true;
            photoDragStartX = touchX - xPos;
            photoDragStartY = touchY - yPos;
            return false;
          } else if (activeElement === 'glasses' && glassesSelected && !hasDownloaded && isMouseOverGlasses(touchX, touchY)) {
            isDraggingGlasses = true;
            glassesDragStartX = touchX - glassesXPos;
            glassesDragStartY = touchY - glassesYPos;
            hasDownloaded = false;
            return false;
          }
        }
        if (!isTouchOverCanvas(touchX, touchY) && !isTouchOverControls(touchX, touchY)) {
          return true;
        }
      } else if (touches.length === 2) {
        let touch1X = touches[0].x;
        let touch1Y = touches[0].y;
        let touch2X = touches[1].x;
        let touch2Y = touches[1].y;
        let midX = (touch1X + touch2X) / 2;
        let midY = (touch1Y + touch2Y) / 2;
        if (!isTouchOverCanvas(midX, midY)) {
          return true;
        }
        if (activeElement === 'photo' && photoLoaded && isMouseOverPhoto(midX, midY)) {
          isPinchingPhoto = true;
          isDraggingPhoto = false;
          initialPinchDistancePhoto = dist(touch1X, touch1Y, touch2X, touch2Y);
          initialScalePhoto = scaleVal;
        } else if (activeElement === 'glasses' && glassesSelected && !hasDownloaded && isMouseOverGlasses(midX, midY)) {
          isPinchingGlasses = true;
          isDraggingGlasses = false;
          initialPinchDistanceGlasses = dist(touch1X, touch1Y, touch2X, touch2Y);
          initialScaleGlasses = glassesScaleVal;
          hasDownloaded = false;
        }
        return false;
      }
      return false;
    }
    function touchEnded(event) {
      isDraggingPhoto = false;
      isPinchingPhoto = false;
      isDraggingGlasses = false;
      isPinchingGlasses = false;
      if (touches.length === 0 && event.changedTouches.length === 1) {
        let touchX = event.changedTouches[0].clientX;
        let touchY = event.changedTouches[0].clientY;
        const buttons = document.querySelectorAll('button, a.button, label.upload-button');
        for (let btn of buttons) {
          const rect = btn.getBoundingClientRect();
          if (touchX >= rect.left && touchX <= rect.right && touchY >= rect.top && touchY <= rect.bottom) {
            const now = Date.now();
            if (btn.id === 'upload-template-label' && now - lastUploadTrigger.template < 500) {
              break;
            }
            if (btn.id === 'upload-photo-label' && now - lastUploadTrigger.photo < 500) {
              break;
            }
            btn.click();
            if (btn.id === 'upload-template-label') {
              lastUploadTrigger.template = now;
            } else if (btn.id === 'upload-photo-label') {
              lastUploadTrigger.photo = now;
            }
            break;
          }
        }
      }
      return false;
    }
    function draw() {
      clear();
      if (templateLoaded && templateImg) {
        fill(0);
        noStroke();
        rect(0, 0, canvasWidth, canvasHeight);
        if (photoLoaded && photoImg && !photoInFront) {
          push();
          translate(xPos + canvasWidth / 2, yPos + canvasHeight / 2);
          rotate(radians(rotationVal));
          scale(scaleVal);
          imageMode(CENTER);
          let scaledHeight = photoImg.height * scaleVal;
          let scaledWidth = scaledHeight * photoAspectRatio;
          image(photoImg, 0, 0, scaledWidth, scaledHeight);
          pop();
        }
        image(templateImg, 0, 0, canvasWidth, canvasHeight);
        if (photoLoaded && photoImg && photoInFront) {
          push();
          translate(xPos + canvasWidth / 2, yPos + canvasHeight / 2);
          rotate(radians(rotationVal));
          scale(scaleVal);
          imageMode(CENTER);
          let scaledHeight = photoImg.height * scaleVal;
          let scaledWidth = scaledHeight * photoAspectRatio;
          image(photoImg, 0, 0, scaledWidth, scaledHeight);
          pop();
        }
        if (glassesSelected && currentGlassesImg) {
          push();
          if (hasDownloaded) {
            translate(xPos + canvasWidth / 2, yPos + canvasHeight / 2);
            rotate(radians(rotationVal));
            scale(scaleVal);
            translate(relativeGlassesX, relativeGlassesY);
            rotate(radians(relativeRotation));
            scale(relativeScale);
          } else {
            translate(glassesXPos + canvasWidth / 2, glassesYPos + canvasHeight / 2);
            rotate(radians(glassesRotationVal));
            scale(glassesScaleVal);
          }
          imageMode(CENTER);
          image(currentGlassesImg, 0, 0);
          pop();
        }
      }
    }
    function validateFile(file, type) {
      const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
      const maxSizeMB = 5;
      if (!allowedTypes.includes(file.type)) {
        return `Please upload a ${type.toLowerCase()} in JPEG, PNG, or GIF format.`;
      }
      if (file.size > maxSizeMB * 1024 * 1024) {
        return `The ${type.toLowerCase()} file exceeds the ${maxSizeMB}MB size limit. Please upload a smaller file.`;
      }
      return null;
    }
    document.addEventListener('DOMContentLoaded', () => {
      const templateUpload = document.getElementById('templateUpload');
      const photoUpload = document.getElementById('photoUpload');
      const xPosSlider = document.getElementById('xPos');
      const yPosSlider = document.getElementById('yPos');
      const scaleSlider = document.getElementById('scale');
      const rotationSlider = document.getElementById('rotation');
      const glassesXPosSlider = document.getElementById('glassesXPos');
      const glassesYPosSlider = document.getElementById('glassesYPos');
      const glassesScaleSlider = document.getElementById('glassesScale');
      const glassesRotationSlider = document.getElementById('glassesRotation');
      const sendBackButton = document.getElementById('sendBack');
      const bringFrontButton = document.getElementById('bringFront');
      const downloadButton = document.getElementById('download');
      const buyTemplateButton = document.getElementById('buy-template');
      const removeBgButton = document.getElementById('remove-bg');
      const uploadTemplateLabel = document.getElementById('upload-template-label');
      const uploadPhotoLabel = document.getElementById('upload-photo-label');
      buyTemplateButton.addEventListener('click', () => {});
      removeBgButton.addEventListener('click', () => {});
      uploadTemplateLabel.addEventListener('click', () => {});
      uploadPhotoLabel.addEventListener('click', () => {});
      if (templateUpload) {
        templateUpload.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
            const validationError = validateFile(file, 'Template');
            if (validationError) {
              alert(validationError);
              templateUpload.value = '';
              return;
            }
            const url = URL.createObjectURL(file);
            loadingMessage.style.display = 'block';
            loadingMessage.textContent = 'Loading template...';
            try {
              loadImage(
                url,
                (img) => {
                  isLandscape = img.width > img.height;
                  if (isLandscape) {
                    document.querySelector('.main-container').classList.add('landscape');
                  } else {
                    document.querySelector('.main-container').classList.remove('landscape');
                  }
                  templateImg = img;
                  originalTemplateWidth = img.width;
                  originalTemplateHeight = img.height;
                  templateLoaded = true;
                  photoInFront = true;
                  glassesSelected = false;
                  currentGlassesImg = null;
                  document.querySelectorAll('.glasses-button').forEach(btn => btn.classList.remove('selected'));
                  xPos = 56.69;
                  yPos = -18.9;
                  scaleVal = photoImg && (photoImg.width > canvasWidth * 2 || photoImg.height > canvasHeight * 2) ? 0.5 : 1.25;
                  rotationVal = 0;
                  glassesXPos = 57;
                  glassesYPos = -57;
                  glassesScaleVal = 0.50625;
                  glassesRotationVal = 0;
                  relativeGlassesX = 0;
                  relativeGlassesY = 0;
                  relativeRotation = 0;
                  relativeScale = 1;
                  hasDownloaded = false;
                  activeElement = 'photo';
                  document.getElementById('xPos').value = xPos;
                  document.getElementById('yPos').value = yPos;
                  document.getElementById('scale').value = scaleVal;
                  document.getElementById('rotation').value = rotationVal;
                  document.getElementById('glassesXPos').value = glassesXPos;
                  document.getElementById('glassesYPos').value = glassesYPos;
                  document.getElementById('glassesScale').value = glassesScaleVal;
                  document.getElementById('glassesRotation').value = glassesRotationVal;
                  updateCanvasSize();
                  updateSliderVisibility();
                  loadingMessage.style.display = 'none';
                  document.getElementById('canvas-container').style.backgroundImage = 'none';
                  URL.revokeObjectURL(url);
                  templateUpload.value = '';
                },
                (err) => {
                  loadingMessage.textContent = 'Failed to load template';
                  setTimeout(() => {
                    loadingMessage.style.display = 'none';
                  }, 3000);
                  alert('Error loading template image: ' + (err.message || 'Unknown error') + '. Please try a different image.');
                  URL.revokeObjectURL(url);
                  templateUpload.value = '';
                }
              );
            } catch (err) {
              loadingMessage.textContent = 'Failed to load template';
              setTimeout(() => {
                loadingMessage.style.display = 'none';
              }, 3000);
              alert('Exception while loading template: ' + (err.message || 'Unknown error') + '. Please try a different image.');
              URL.revokeObjectURL(url);
              templateUpload.value = '';
            }
          }
        });
      }
      if (photoUpload) {
        photoUpload.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
            const validationError = validateFile(file, 'Photo');
            if (validationError) {
              alert(validationError);
              photoUpload.value = '';
              return;
            }
            const url = URL.createObjectURL(file);
            loadingMessage.style.display = 'block';
            loadingMessage.textContent = 'Loading photo...';
            try {
              loadImage(
                url,
                (img) => {
                  photoAspectRatio = img.width / img.height;
                  photoImg = img;
                  if (img.width > canvasWidth * 2 || img.height > canvasHeight * 2) {
                    scaleVal = 0.5;
                  } else {
                    scaleVal = 1.25;
                  }
                  document.getElementById('scale').value = scaleVal;
                  document.getElementById('xPos').value = xPos;
                  document.getElementById('yPos').value = yPos;
                  document.getElementById('rotation').value = rotationVal;
                  photoLoaded = true;
                  loadingMessage.style.display = 'none';
                  updateCanvasSize();
                  updateSliderVisibility();
                  URL.revokeObjectURL(url);
                  photoUpload.value = '';
                },
                (err) => {
                  loadingMessage.textContent = 'Failed to load photo';
                  setTimeout(() => {
                    loadingMessage.style.display = 'none';
                  }, 3000);
                  alert('Error loading photo image: ' + (err.message || 'Unknown error') + '. Please try a different image.');
                  URL.revokeObjectURL(url);
                  photoUpload.value = '';
                }
              );
            } catch (err) {
              loadingMessage.textContent = 'Failed to load photo';
              setTimeout(() => {
                loadingMessage.style.display = 'none';
              }, 3000);
              alert('Exception while loading photo: ' + (err.message || 'Unknown error') + '. Please try a different image.');
              URL.revokeObjectURL(url);
              photoUpload.value = '';
            }
          }
        });
      }
      function selectGlasses(index) {
        document.querySelectorAll('.glasses-button').forEach(btn => btn.classList.remove('selected'));
        document.getElementById(`glasses${index + 1}`).classList.add('selected');
        currentGlassesImg = glassesImgs[index];
        glassesSelected = true;
        activeElement = 'glasses';
        updateCanvasSize();
        updateSliderVisibility();
      }
      glassesUrls.forEach((_, index) => {
        document.getElementById(`glasses${index + 1}`).addEventListener('click', () => {
          selectGlasses(index);
        });
      });
      if (xPosSlider) {
        xPosSlider.addEventListener('input', (e) => {
          if (activeElement === 'photo') {
            xPos = parseInt(e.target.value);
            hasDownloaded = false;
          }
        });
        xPosSlider.addEventListener('touchstart', (e) => {
          e.stopPropagation();
        });
      }
      if (yPosSlider) {
        yPosSlider.addEventListener('input', (e) => {
          if (activeElement === 'photo') {
            yPos = parseInt(e.target.value);
            hasDownloaded = false;
          }
        });
        yPosSlider.addEventListener('touchstart', (e) => {
          e.stopPropagation();
        });
      }
      if (scaleSlider) {
        scaleSlider.addEventListener('input', (e) => {
          if (activeElement === 'photo') {
            scaleVal = parseFloat(e.target.value);
            hasDownloaded = false;
          }
        });
        scaleSlider.addEventListener('touchstart', (e) => {
          e.stopPropagation();
        });
      }
      if (rotationSlider) {
        rotationSlider.addEventListener('input', (e) => {
          if (activeElement === 'photo') {
            rotationVal = parseFloat(e.target.value);
            hasDownloaded = false;
          }
        });
        rotationSlider.addEventListener('touchstart', (e) => {
          e.stopPropagation();
        });
      }
      if (glassesXPosSlider) {
        glassesXPosSlider.addEventListener('input', (e) => {
          if (activeElement === 'glasses') {
            glassesXPos = parseInt(e.target.value);
            hasDownloaded = false;
          }
        });
        glassesXPosSlider.addEventListener('touchstart', (e) => {
          e.stopPropagation();
        });
      }
      if (glassesYPosSlider) {
        glassesYPosSlider.addEventListener('input', (e) => {
          if (activeElement === 'glasses') {
            glassesYPos = parseInt(e.target.value);
            hasDownloaded = false;
          }
        });
        glassesYPosSlider.addEventListener('touchstart', (e) => {
          e.stopPropagation();
        });
      }
      if (glassesScaleSlider) {
        glassesScaleSlider.addEventListener('input', (e) => {
          if (activeElement === 'glasses') {
            glassesScaleVal = parseFloat(e.target.value);
            hasDownloaded = false;
          }
        });
        glassesScaleSlider.addEventListener('touchstart', (e) => {
          e.stopPropagation();
        });
      }
      if (glassesRotationSlider) {
        glassesRotationSlider.addEventListener('input', (e) => {
          if (activeElement === 'glasses') {
            glassesRotationVal = parseFloat(e.target.value);
            hasDownloaded = false;
          }
        });
        glassesRotationSlider.addEventListener('touchstart', (e) => {
          e.stopPropagation();
        });
      }
      if (sendBackButton) {
        sendBackButton.addEventListener('click', () => {
          photoInFront = false;
        });
      }
      if (bringFrontButton) {
        bringFrontButton.addEventListener('click', () => {
          photoInFront = true;
        });
      }
      if (downloadButton) {
        downloadButton.addEventListener('click', () => {
          if (templateLoaded && photoLoaded && templateImg && photoImg) {
            const resolutionMultiplier = 2;
            let highResWidth = originalTemplateWidth * resolutionMultiplier;
            let highResHeight = originalTemplateHeight * resolutionMultiplier;
            let highResCanvas = createGraphics(highResWidth, highResHeight);
            if (templateLoaded) {
              highResCanvas.fill(0);
              highResCanvas.noStroke();
              highResCanvas.rect(0, 0, highResWidth, highResHeight);
            }
            if (!photoInFront) {
              highResCanvas.push();
              highResCanvas.translate((xPos + canvasWidth / 2) * (highResWidth / canvasWidth), (yPos + canvasHeight / 2) * (highResHeight / canvasHeight));
              highResCanvas.rotate(radians(rotationVal));
              highResCanvas.scale(scaleVal);
              highResCanvas.imageMode(CENTER);
              let scaledHeight = photoImg.height * scaleVal;
              let scaledWidth = scaledHeight * photoAspectRatio;
              highResCanvas.image(photoImg, 0, 0, scaledWidth * (highResWidth / canvasWidth), scaledHeight * (highResHeight / canvasHeight));
              highResCanvas.pop();
            }
            highResCanvas.image(templateImg, 0, 0, highResWidth, highResHeight);
            if (photoInFront) {
              highResCanvas.push();
              highResCanvas.translate((xPos + canvasWidth / 2) * (highResWidth / canvasWidth), (yPos + canvasHeight / 2) * (highResHeight / canvasHeight));
              highResCanvas.rotate(radians(rotationVal));
              highResCanvas.scale(scaleVal);
              highResCanvas.imageMode(CENTER);
              let scaledHeight = photoImg.height * scaleVal;
              let scaledWidth = scaledHeight * photoAspectRatio;
              highResCanvas.image(photoImg, 0, 0, scaledWidth * (highResWidth / canvasWidth), scaledHeight * (highResHeight / canvasHeight));
              highResCanvas.pop();
            }
            if (glassesSelected && currentGlassesImg) {
              highResCanvas.push();
              if (hasDownloaded) {
                highResCanvas.translate((xPos + canvasWidth / 2) * (highResWidth / canvasWidth), (yPos + canvasHeight / 2) * (highResHeight / canvasHeight));
                highResCanvas.rotate(radians(rotationVal));
                highResCanvas.scale(scaleVal);
                highResCanvas.translate(relativeGlassesX * (highResWidth / canvasWidth), relativeGlassesY * (highResHeight / canvasHeight));
                highResCanvas.rotate(radians(relativeRotation));
                highResCanvas.scale(relativeScale);
              } else {
                highResCanvas.translate((glassesXPos + canvasWidth / 2) * (highResWidth / canvasWidth), (glassesYPos + canvasHeight / 2) * (highResHeight / canvasHeight));
                highResCanvas.rotate(radians(glassesRotationVal));
                highResCanvas.scale(glassesScaleVal);
              }
              highResCanvas.imageMode(CENTER);
              highResCanvas.image(currentGlassesImg, 0, 0, currentGlassesImg.width * (highResWidth / canvasWidth), currentGlassesImg.height * (highResHeight / canvasHeight));
              highResCanvas.pop();
              if (!hasDownloaded) {
                let theta = radians(rotationVal);
                let cosTheta = Math.cos(theta);
                let sinTheta = Math.sin(theta);
                let dx = glassesXPos - xPos;
                let dy = glassesYPos - yPos;
                relativeGlassesX = (dx * cosTheta + dy * sinTheta) / scaleVal;
                relativeGlassesY = (-dx * sinTheta + dy * cosTheta) / scaleVal;
                relativeRotation = glassesRotationVal - rotationVal;
                relativeScale = glassesScaleVal / scaleVal;
                document.getElementById('glassesXPos').value = glassesXPos;
                document.getElementById('glassesYPos').value = glassesYPos;
                document.getElementById('glassesScale').value = glassesScaleVal;
                document.getElementById('glassesRotation').value = glassesRotationVal;
              }
            }
            highResCanvas.canvas.toBlob((blob) => {
              const url = URL.createObjectURL(blob);
              const link = document.createElement('a');
              link.href = url;
              link.download = 'MIBBadge.png';
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              URL.revokeObjectURL(url);
              hasDownloaded = true;
            }, 'image/png');
          } else {
            alert('Please upload both a template and a photo.');
          }
        });
      }
      window.addEventListener('resize', () => {
        updateCanvasSize();
      });
    });
  </script>
</body>
</html>
